name: Latest Logfile Monitor & Update README

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:
  push:
    paths: ['logs/**', 'src/**']

jobs:
  monitor-and-update:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Generate logs with Logger
      run: |
        npx tsx -e "
        import { Logger } from './src/logger.js';
        const logger = new Logger('ghp_testtoken');
        logger.log('Workflow test log');
        logger.logConfig({ owner: '${{ github.repository_owner }}', repo: '${{ github.event.repository.name }}' });
        await logger.saveToFile();
        "
    
    - name: Extract latest log info
      id: loginfo
      run: |
        cd logs
        LATEST_LOG=$(ls -t logfile-*.log | head -n1 || echo "No logs found")
        if [ -f "$LATEST_LOG" ]; then
          LINE_COUNT=$(wc -l < "$LATEST_LOG")
          FILE_SIZE=$(du -h "$LATEST_LOG" | cut -f1)
          LAST_MODIFIED=$(stat -c %y "$LATEST_LOG")
          LAST_LINES=$(tail -5 "$LATEST_LOG")
        else
          LINE_COUNT=0
          FILE_SIZE="0B"
          LAST_MODIFIED="No logs"
          LAST_LINES="No logs generated yet"
        fi
        echo "log-file=$LATEST_LOG" >> $GITHUB_OUTPUT
        echo "line-count=$LINE_COUNT" >> $GITHUB_OUTPUT
        echo "file-size=$FILE_SIZE" >> $GITHUB_OUTPUT
        echo "last-modified=$LAST_MODIFIED" >> $GITHUB_OUTPUT
        echo "last-lines<<EOF" >> $GITHUB_OUTPUT
        $LAST_LINES
        EOF
    
    - name: Update README with log details
      run: |
        # Create updated log section
        cat > temp-log-section.md << EOF
        <!-- LOG-STATUS-START -->
        **Latest: \`${{ steps.loginfo.outputs.log-file }}\`**

        | Metric | Value |
        |--------|-------|
        | Lines | ${{ steps.loginfo.outputs.line-count }} |
        | Size  | ${{ steps.loginfo.outputs.file-size }} |
        | Updated | ${{ steps.loginfo.outputs.last-modified }} |

        **üìÑ Last 5 Lines:**
        \`\`\`
        ${{ steps.loginfo.outputs.last-lines }}
        \`\`\`
        <!-- LOG-STATUS-END -->
        EOF
        
        # Replace log section in README
        awk '
        /<!-- LOG-STATUS-START -->/{print; system("cat temp-log-section.md"); next}
        /<!-- LOG-STATUS-END -->/{next}
        {print}
        ' README.md > README.new || true
        
        # Fallback if awk fails
        sed -i '/<!-- LOG-STATUS-START -->/,/<!-- LOG-STATUS-END -->/c\\<!-- LOG-STATUS-START -->\n**Latest: `${{ steps.loginfo.outputs.log-file }}`**\n\n| Metric | Value |\n|--------|-------|\n| Lines | ${{ steps.loginfo.outputs.line-count }} |\n| üìè Size  | ${{ steps.loginfo.outputs.file-size }} |\n| Updated | ${{ steps.loginfo.outputs.last-modified }} |\n\n**Last 5 Lines:**\n\`\`\`\n${{ steps.loginfo.outputs.last-lines }}\n\`\`\`\n<!-- LOG-STATUS-END -->' README.md
        
        mv README.new README.md 2>/dev/null || true
        rm -f temp-log-section.md
    
    - name: Commit README update
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Update README: ${{ steps.loginfo.outputs.log-file }} (#${{ github.run_number }})"
        file_pattern: README.md
    
    - name: Upload logs
      uses: actions/upload-artifact@v4
      with:
        name: latest-logs-${{ github.run_number }}
        path: logs/
